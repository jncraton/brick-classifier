<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title></title>
    <style>
    body {
      max-width:800px;
      margin: 0 auto;
    }

    * {
      font-size: 24px;
    }
    </style>
  </head>

  <body>
    <label>Photo</label><br/>
    <input type="file" id="imageLoader" name="imageLoader" accept="image/*" capture="camera" />
    <canvas id="imageCanvas"></canvas>
    <ol id=results></ol>
    <section id=log></section>
    
    <!-- Load ONNX.js -->
    <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
    <script src="./ndarray.js"></script>
    <script src="./image-loader.js"></script>
    <!-- Code that consume ONNX.js -->
    <script>
      const class_names = ["3004", "3005", "3020", "3023", "3024", "3069b", "3710", "54200", "6141", "98138"]

      var imageLoader = document.getElementById('imageLoader');
          imageLoader.addEventListener('change', handleImage, false);
      var canvas = document.getElementById('imageCanvas');
      var ctx = canvas.getContext('2d');

      function log(msg) {
        console.log(msg)
        document.getElementById('log').innerHTML += '<br>' + msg
      }

      function handleImage(e){
          var reader = new FileReader();
          reader.onload = function(event){
              var img = new Image();
              img.onload = function(){
                  canvas.width = img.width;
                  canvas.height = img.height;
                  ctx.drawImage(img,0,0);
              }
              img.src = event.target.result;
              classify(event.target.result)
          }
          reader.readAsDataURL(e.target.files[0]);     
      }
    
      function preprocess(data, width, height) {
        const dataFromImage = ndarray(new Float32Array(data), [width, height, 4]);
        const dataProcessed = ndarray(new Float32Array(width * height * 3), [1, 3, height, width]);

        // Normalize 0-255 to (-1)-1
        ndarray.ops.divseq(dataFromImage, 128.0);
        ndarray.ops.subseq(dataFromImage, 1.0);

        // Realign imageData from [224*224*4] to the correct dimension [1*3*224*224].
        ndarray.ops.assign(dataProcessed.pick(0, 0, null, null), dataFromImage.pick(null, null, 2));
        ndarray.ops.assign(dataProcessed.pick(0, 1, null, null), dataFromImage.pick(null, null, 1));
        ndarray.ops.assign(dataProcessed.pick(0, 2, null, null), dataFromImage.pick(null, null, 0));

        return dataProcessed.data;
      }

      function classify(img) {
        log('loading model...')
        // create a session
        const myOnnxSession = new onnx.InferenceSession();
        // load the ONNX model file
        myOnnxSession.loadModel('./part-classifier.onnx').then(() => {
          log('model loaded. loading image...')
          // generate model input
          const imageLoader = new ImageLoader(224, 224);
          imageLoader.getImageData(img).then((imageData) => {
            const preprocessedData = preprocess(imageData.data, 224, 224);
            const inputTensor = new onnx.Tensor(preprocessedData, 'float32', [1, 3, 224, 224]);
            log('image loaded. running inference...')

            myOnnxSession.run([inputTensor]).then((output) => {
              const outputTensor = output.values().next().value;

              log(`${outputTensor.data}`)
              
              let results = class_names.map((name, i) => { 
                return [outputTensor.data[i], class_names[i]]
              })

              results.sort((a, b) => b[0] - a[0])

              const items = results.map(item => {
                return `<img src="https://cdn.rebrickable.com/media/thumbs/parts/ldraw/71/${item[1]}.png/72x72p.png" alt="${item[1]}" /> ${item[1]} (${item[0]})`
              })
              
              document.getElementById('results').innerHTML = '<li>' + items.join('<li>')
            });
          });
        });
      }
    </script>
  </body>
</html>
